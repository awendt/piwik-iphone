<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="robots" content="noindex">
    <title>piwik + jQTouch</title>
    <link type="text/css" rel="stylesheet" href="jqtouch/jqtouch.min.css"/>
    <link type="text/css" rel="stylesheet" href="jqtouch/apple-theme/theme.min.css"/>
    <link type="text/css" rel="stylesheet" href="app.css"/>
    <script type="text/javascript" src="jquery-1.5.1.min.js"></script>
    <script type="text/javascript" src="jqtouch/jqtouch.min.js" ></script>
    <script type="text/javascript" src="flot/jquery.flot.min.js" ></script>
    <script type="text/javascript" src="underscore-min.js" ></script>
    <script type="text/javascript" src="piwik.js" ></script>
    <script type="text/javascript">

      var jQT = $.jQTouch({
        icon: 'jqtouch.png',
        slideSelector: 'body > * > ul li a',
        addGlossToIcon: false,
        startupScreen: 'jqt_startup.png',
        statusBar: 'black',
        preloadImages: [
          'jqtouch/apple-theme/img/backButton.png',
          'jqtouch/apple-theme/img/grayButton.png',
          'jqtouch/apple-theme/img/whiteButton.png',
          'jqtouch/apple-theme/img/loading.gif'
          ]
      });

      $(function(){
        var init = function() {
          $("#dashboard h2").text("Statistics for "+ localStorage.site_name);
          if (localStorage.period) {
            $("#period").val(localStorage.period);
          }
        };

        if (!(localStorage.install && localStorage.site)) {
          jQT.goTo('#settings', 'slideup');
        } else if (localStorage.site_name) {
          init();
        }

        // helper for returning the weekends in a period
        // Credit: examples/visitors.html
        var weekendAreas = function(axes) {
            var markings = [];
            var d = new Date(axes.xaxis.min);
            // go to the first Saturday
            d.setUTCDate(d.getUTCDate() - ((d.getUTCDay() + 1) % 7))
            d.setUTCSeconds(0);
            d.setUTCMinutes(0);
            d.setUTCHours(0);
            var i = d.getTime();
            do {
                // when we don't set yaxis, the rectangle automatically
                // extends to infinity upwards and downwards
                markings.push({ xaxis: { from: i, to: i + 2 * 24 * 60 * 60 * 1000 } });
                i += 7 * 24 * 60 * 60 * 1000;
            } while (i < axes.xaxis.max);

            return markings;
        };

        var unix_milliseconds_from = function(piwik_date) {
          return piwik.convert_date(piwik_date).getTime();
        };

        var timeformat_for_period = function() {
          switch(localStorage.period) {
            case "day": return "%d"; break;
            case "week": return "%b"; break;
            case "month": return "%b"; break;
            case "year": return "%y"; break;
          }
        };

        var default_flot_options = {
          grid: { markings: weekendAreas },
          points: {
            show: true
          },
          lines: {
            show: true
          },
          xaxis: {
            mode: "time", timeformat: timeformat_for_period()
          }
        };
        var get_visitors = function() {
          piwik.get('VisitsSummary.get', '#visits', function(json) {
            var visits = _.map(json, function(summary, date) {
              return [unix_milliseconds_from(date), summary['nb_visits']];
            });
            var bounces = _.map(json, function(summary, date) {
              return [unix_milliseconds_from(date), summary['bounce_count']];
            });
            var conversions = _.map(json, function(summary, date) {
              return [unix_milliseconds_from(date), summary['nb_visits_converted'] || 0];
            });
            $("#visits").css({width: '280px', height:'350px'});
            var d1 = {label: 'Total Visitors', color: 0, data: visits};
            var d2 = {label: 'Bounces', color: 2, data: bounces};
            var d3 = {label: 'Conversions', color: 3, data: conversions};
            $.plot($("#visits"), [d1, d2, d3], default_flot_options);
            $("#visitors .loading").hide();
          });
        };

        var get_conversion_rate = function() {
          piwik.get('Goals.getConversionRate', '#conversion_rate_graph', function(json) {
            var conversion_rates = _.map(json, function(rate, date) {
              return [unix_milliseconds_from(date), rate];
            });
            $("#conversion_rate_graph").css({width: '280px', height:'350px'});
            $.plot($("#conversion_rate_graph"), [conversion_rates], default_flot_options);
            $("#conversion_rate .loading").hide();
          });
        };

        $('#querySites').click(function() {
          if ($("#install").val() === "") { return; }

          $.getJSON(
            piwik.url_for({
              install: $("#install").val(),
              method: 'SitesManager.getSitesWithViewAccess',
              token_auth: $("#token").val()
            }),
            function(json) {
              if (json.length === 0) {
                alert("Sorry, I couldn't find any sites I can access.\n\n" +
                    "Are URL and token really correct?");
                return;
              }
              $.each(json, function(key, site) {
                $("#site").append('<option value="'+ site.idsite +'">'+ site.name +'</option>');
              });
              $(".question3").show();
              $('#querySites').hide();
            }
          );
        });

        $("#visitors").bind('pageAnimationEnd', function(event, info) {
          if (info.direction == "out") { return; }
          get_visitors();
        });

        $("#conversion_rate").bind('pageAnimationEnd', function(event, info) {
          if (info.direction == "out") { return; }
          get_conversion_rate();
        });

        $("#dashboard").bind('pageAnimationEnd', function(event, info) {
          if (info.direction == "out") { return; }
          init();
        });

        $("#save").click(function() {
          localStorage.install = $('#install').val();
          localStorage.token = $('#token').val();
          localStorage.site = $('#site').val();
          localStorage.site_name = $('#site :selected').text();
          jQT.goBack();
        });

        $("#period").change(function() {
          localStorage.period = $(this).val();
        });
      });
    </script>
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  </head>
  <body>
    <div id="visitors">
      <div class="toolbar">
        <h1>Visits</h1>
        <a class="back" href="#home">Back</a>
      </div>
      <ul class="edit rounded">
        <div class="loading"></div>
        <div id="visits"></div>
      </ul>
    </div>
    <div id="conversion_rate">
      <div class="toolbar">
        <h1>Conversion rate</h1>
        <a class="back" href="#home">Back</a>
      </div>
      <ul class="edit rounded">
        <div class="loading"></div>
        <div id="conversion_rate_graph"></div>
      </ul>
    </div>
    <div id="settings">
      <div class="toolbar">
        <h1>Settings</h1>
        <a href="#" class="cancel button">Cancel</a>
      </div>
      <form>
        <h2>Where is your Piwik installation hosted?</h2>
        <ul class="edit rounded question1">
          <li><input type="url" name="install" placeholder="http://piwik.org/demo" id="install" /></li>
        </ul>
        <h2>Please provide a token for a user with read access:</h2>
        <ul class="edit rounded question2">
          <li><input type="text" name="token" placeholder="32-char hash" id="token" /></li>
        </ul>
        <a href="#" id="querySites" style="margin:10px;" class="whiteButton submit">Show sites</a>
        <div style="display:none;" class="question3">
          <h2>Please choose a site:</h2>
          <ul class="edit rounded">
            <li>
              <select id="site">
              </select>
            </li>
          </ul>
          <a href="#" class="whiteButton submit" id="save" style="margin:10px;">Save</a>
        </div>
      </form>
    </div>
    <div id="dashboard" class="current slideup">
      <div class="toolbar">
        <h1>Dashboard</h1>
        <a href="#settings" class="button slideup">Settings</a>
      </div>
      <h2>No website set up</h2>
      <ul class="rounded">
        <li class="arrow"><a href="#visitors">Visitors</a></li>
        <li class="arrow"><a href="#conversion_rate">Conversion rate</a></li>
        <li>
          <select id="period">
            <option value="day">Daily</option>
            <option value="week">Weekly</option>
            <option value="month">Monthly</option>
            <option value="year">Yearly</option>
          </select>
        </li>
      </ul>
    </div>
  </body>
</html>